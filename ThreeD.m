%% Parameter Definition
M = 6;                      % Sections in transverse direction
N = 30;                     % Sections along the surface
P = 30;                     % Sections along the surface

Grid_size = 0.01;           % Grid size in metres

Alpha = 2.32e-5;            % Coefficient of Thermal Expansion

X_def = zeros(P*N*M,1);     % X-deformation
Y_def = zeros(P*N*M,1);     % Y-deformation
Z_def = zeros(P*N*M,1);     % Z-deformation

T_ref = 300;                % Temperature at which thermal strain is zero
T1 = 400;                   % Temperature at the centre of top surface
T2 = 250;                   % Temperature at the centre of bottom surface

lambda1 = -0.25;            % Constant for top surface
lambda2 = -0.5;             % Constant for bottom surface

Output = zeros(P*N*M,5);    % Output Matrix

A = zeros((P-1)*(N-1)*(M-1),(P-1)*(N-1)*(M-1));     % Matrix initialization
B = zeros((P-1)*(N-1)*(M-1),1);                     % Matrix initialization

BC1 = zeros(P+1,N+1);       % YZ - Boundary condition top surface
BC2 = zeros(P+1,M+1);       % ZX - Boundary condition side surface
BC3 = zeros(N+1,M+1);       % YX - Boundary condition side surface
BC4 = zeros(P+1,N+1);       % YZ - Boundary condition bottom surface
BC5 = zeros(P+1,M+1);       % ZX - Boundary condition side surface
BC6 = zeros(N+1,M+1);       % YX - Boundary condition side surface

T = zeros(P+1,N+1,M+1);     % Temperature at all nodes
Temp = zeros(P,N,M);        % Temperature of all volume elements

GridID = zeros(P*N*M,1);    % Grid ID

%% Boundary Conditions
BC2(:,:) = 200;
BC5(:,:) = 200;
BC3(:,:) = 200;
BC6(:,:) = 200;
for p = 1:P+1
    for n = 1:N+1
        BC1(p,n) = T1 + lambda1*sqrt((p-(P/2 + 1))^2 + (n-(N/2 + 1))^2);
        BC4(p,n) = T2 + lambda2*sqrt((p-(P/2 + 1))^2 + (n-(N/2 + 1))^2);
    end
end

%% Finding A and B
for m = 1:M-1
    for n = 1:N-1
        for p = 1:P-1
            A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p) = -6;
            
%% in  medium

            if (m~=1 && m~=M-1) && (n~=1 && n~=N-1) && (p~=1 && p~=P-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = 0;
            
%% corners 
            
            elseif (p==1)&&(n==1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC2(p+1,m+1)+BC3(n+1,m+1));
            elseif (p==1)&&(n==N-1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC5(p+1,m+1)+BC3(n+1,m+1));
            elseif (p==1)&&(n==1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1)+BC3(n+1,m+1)+BC4(p+1,m+1));
            elseif (p==1)&&(n==N-1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC5(p+1,m+1)+BC4(p+1,n+1)+BC3(n+1,m+1));
            elseif (p==P-1)&&(n==1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC2(p+1,m+1)+BC6(n+1,m+1));
            elseif (p==P-1)&&(n==N-1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC5(p+1,m+1)+BC6(n+1,m+1));
            elseif (p==P-1)&&(n==1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1)+BC4(p+1,n+1)+BC6(n+1,m+1));
            elseif (p==P-1)&&(n==N-1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC4(p+1,n+1)+BC5(p+1,m+1)+BC6(n+1,m+1));
            
%% edges

            elseif (p==1)&&(n~=1&&n~=N-1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC3(n+1,m+1));
            elseif (p==1)&&(n~=1&&n~=N-1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC4(p+1,n+1)+BC3(n+1,m+1));
            elseif (p==P-1)&&(n~=1&&n~=N-1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC6(n+1,m+1));
            elseif (p==P-1)&&(n~=1&&n~=N-1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC4(p+1,n+1)+BC6(n+1,m+1));
            elseif (p==1)&&(n==1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1)+BC3(n+1,m+1));
            elseif (p==1)&&(n==N-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC3(n+1,m+1)+BC5(p+1,m+1));
            elseif (p==P-1)&&(n==1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1)+BC6(n+1,m+1));
            elseif (p==P-1)&&(n==N-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC5(p+1,m+1)+BC6(n+1,m+1));
            elseif (p~=1)&&(p~=P-1)&&(n==1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC2(p+1,m+1));
            elseif (p~=1)&&(p~=P-1)&&(n==1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1)+BC4(p+1,n+1));
            elseif (p~=1)&&(p~=P-1)&&(n==N-1)&&(m==1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1)+BC5(p+1,m+1));
            elseif (p~=1)&&(p~=P-1)&&(n==N-1)&&(m==M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC4(p+1,m+1)+BC5(p+1,m+1));

%% faces

            elseif (p==1)&&(n~=1&&n~=N-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC3(n+1,m+1));
            elseif (p==P-1)&&(n~=1&&n~=N-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC6(n+1,m+1));
            elseif (n==1)&&(p~=1&&p~=P-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC2(p+1,m+1));
            elseif (n==N-1)&&(p~=1&&p~=P-1)&&(m~=1&&m~=M-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC5(p+1,m+1));
            elseif (m==1)&&(n~=1&&n~=N-1)&&(p~=1&&p~=P-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC1(p+1,n+1));
            elseif (m==M-1)&&(n~=1&&n~=N-1)&&(p~=1&&p~=P-1)
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-2)*(P-1)*(N-1))+((P-1)*(n-1))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-2))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n))+p) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p+1) = 1;
                A(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p-1) = 1;
                B(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = -(BC4(p+1,n+1));
            end
        end
    end
end

%% Solving Linear Equations
X = pinv(A)*B;
X = reshape(X,[P-1,N-1,M-1]);

%% Temperature at nodes
T(:,:,1) = BC1;
T(:,:,M+1) = BC4;
T(:,1,:) = BC2;
T(:,N+1,:) = BC5;
T(1,:,:) = BC3;
T(P+1,:,:) = BC6;

for m = 2:M
    for n = 2:N
        for p = 2:P
            T(p,n,m) = X(p-1,n-1,m-1);
        end
    end
end

%% Temperature of volume elements
Temp = zeros(P,N,M);
for m = 1:M
    for n = 1:N
        for p = 1:P
            GridID(((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p,1) = ((m-1)*(P-1)*(N-1))+((P-1)*(n-1))+p;
            Temp(p,n,m) = (T(p,n,m)+T(p,n+1,m)+T(p,n,m+1)+T(p,n+1,m+1)+T(p+1,n,m)+T(p+1,n+1,m)+T(p+1,n,m+1)+T(p+1,n+1,m+1))/8;
        end
    end
end

%% Temperature at Grid ID
T_ID = [GridID reshape(Temp,[P*N*M,1])];

%% Deformations
for i = 1:P*N*M
    X_def(i,1) = Grid_size*Alpha*(T_ID(i)-T_ref);
    Y_def(i,1) = Grid_size*Alpha*(T_ID(i)-T_ref);
    Z_def(i,1) = Grid_size*Alpha*(T_ID(i)-T_ref);
end

Output = [T_ID X_def Y_def Z_def];
writematrix(Output,"Thermal_Deformation_Data.xls","Sheet",1,"Range","A2:E5401");